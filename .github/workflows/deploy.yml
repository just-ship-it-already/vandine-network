name: Deploy Network Monitor

on:
  push:
    branches:
      - dev
      - staging
      - main
  pull_request:
    branches:
      - main
      - staging

jobs:
  # Linting and Testing
  test:
    name: Test & Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Validate HTML structure
        run: |
          echo "Validating HTML files..."
          if [ -f vandine-showcase.html ]; then
            # Basic HTML validation
            grep -q "<!DOCTYPE html>" vandine-showcase.html && echo "âœ… HTML doctype found"
            grep -q "<html" vandine-showcase.html && echo "âœ… HTML tag found"
            grep -q "</html>" vandine-showcase.html && echo "âœ… HTML properly closed"
          else
            echo "âŒ Main HTML file not found"
            exit 1
          fi
      
      - name: Check for sensitive data
        run: |
          echo "Checking for exposed credentials..."
          # Check for common secret patterns (excluding .env files)
          if grep -r "password=\|secret=\|api_key=\|token=" --include="*.html" --include="*.js" --exclude-dir=".git" . 2>/dev/null | grep -v "example\|placeholder\|your" ; then
            echo "âš ï¸ Potential secrets found in code"
            exit 1
          else
            echo "âœ… No exposed secrets found"
          fi
      
      - name: Check file sizes
        run: |
          echo "Checking file sizes..."
          find . -name "*.html" -size +1M -exec echo "âš ï¸ Large HTML file: {}" \;
          echo "âœ… File size check complete"
      
      - name: Verify required files
        run: |
          echo "Checking required files..."
          [ -f README.md ] && echo "âœ… README.md exists" || exit 1
          [ -f .gitignore ] && echo "âœ… .gitignore exists" || exit 1
          [ -f vandine-showcase.html ] && echo "âœ… Main HTML exists" || exit 1
          echo "âœ… All required files present"

  # Development Deployment
  deploy-dev:
    name: Deploy to Development
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup environment
        run: |
          echo "Setting up development environment"
          if [ -f .env.development ]; then
            cp .env.development .env
            echo "âœ… Development environment configured"
          fi
      
      - name: Build for development
        run: |
          echo "Building for development..."
          echo "Build timestamp: Sat Sep  6 11:20:16 PDT 2025" > build.txt
          echo "Environment: development" >> build.txt
          echo "Branch: ${{ github.ref_name }}" >> build.txt
          echo "âœ… Build complete"
      
      - name: Deploy notification
        run: |
          echo "ðŸ“¦ Development deployment complete"
          echo "URL: https://dev.rafael.vandine.us (configure your server)"

  # Staging Deployment  
  deploy-staging:
    name: Deploy to Staging
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup environment
        run: |
          echo "Setting up staging environment"
          if [ -f .env.staging ]; then
            cp .env.staging .env
            echo "âœ… Staging environment configured"
          fi
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          # Check if main files exist and are valid
          [ -f vandine-showcase.html ] && echo "âœ… Main page exists"
          # Check HTML is valid
          grep -q "<!DOCTYPE html>" vandine-showcase.html && echo "âœ… Valid HTML"
          echo "âœ… Smoke tests passed"
      
      - name: Deploy notification
        run: |
          echo "ðŸš€ Staging deployment complete"
          echo "URL: https://staging.rafael.vandine.us (configure your server)"

  # Production Deployment
  deploy-production:
    name: Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup environment
        run: |
          echo "Setting up production environment"
          if [ -f .env.production ]; then
            cp .env.production .env
            echo "âœ… Production environment configured"
          fi
      
      - name: Production checks
        run: |
          echo "Running production safety checks..."
          # Verify no debug code
          if grep -r "console.log\|debugger" --include="*.html" --include="*.js" . 2>/dev/null | grep -v "//" ; then
            echo "âš ï¸ Debug code found - review before production"
          fi
          echo "âœ… Production checks complete"
      
      - name: Create release info
        run: |
          echo "Creating release information..."
          echo "Release: ${{ github.sha }}" > release.txt
          echo "Date: Sat Sep  6 11:20:16 PDT 2025" >> release.txt
          echo "âœ… Release info created"
      
      - name: Deploy notification
        run: |
          echo "âœ¨ Production deployment complete"
          echo "URL: https://rafael.vandine.us"
